# E820 메모리 맵 (Memory Map)

## 1. 메모리 감지의 필요성
컴퓨터마다 장착된 RAM의 용량은 제각각입니다 (4GB, 8GB, 16GB...). 운영체제는 부팅 초기에 **"사용 가능한 물리 메모리의 범위"**를 정확히 알아야 합니다. 무턱대고 메모리를 쓰다가는 장치(Device)가 사용하는 예약된 영역(MMIO)을 건드려 시스템을 다운시킬 수 있습니다.

## 2. BIOS 인터럽트 0x15, E820
x86 리얼 모드에서 BIOS가 제공하는 `int 0x15, eax=0xE820` 서비스는 시스템의 메모리 지도를 제공합니다. 이 정보는 부트로더 단계에서 얻어야 하며, 보호 모드나 롱 모드로 진입한 후에는 (가상 8086 모드를 쓰지 않는 한) 호출할 수 없습니다.

### 2.1. 호출 규약
- **Input:**
  - `EAX`: `0xE820` (Function Code)
  - `EDX`: `0x534D4150` ('SMAP' 매직 넘버)
  - `EBX`: 0부터 시작하여, 다음 호출 시 BIOS가 리턴한 값 (Continuation)
  - `ECX`: 버퍼 크기 (보통 24 바이트)
  - `ES:DI`: 결과를 저장할 버퍼 주소

- **Output:**
  - `EAX`: 'SMAP'
  - `ES:DI`: 결과가 저장됨 (Base, Length, Type)
  - `EBX`: 0이면 마지막 엔트리, 아니면 다음 엔트리를 얻기 위해 재사용.

### 2.2. 반환 구조체 (Memory Map Entry)
BIOS는 `ES:DI`가 가리키는 버퍼에 아래 구조체를 채워줍니다. (기본 20바이트, ACPI 3.0부터 24바이트)

| Offset | Size | Description |
| :--- | :--- | :--- |
| 0 | 8 bytes | **Base Address** (구간 시작 주소) |
| 8 | 8 bytes | **Length** (구간 길이) |
| 16 | 4 bytes | **Type** (메모리 타입) |
| 20 | 4 bytes | Extended Attributes (Optional) |

#### 메모리 타입 (Type)
- **1:** Usable RAM (운영체제가 사용 가능)
- **2:** Reserved (사용 불가, 하드웨어/BIOS 전용)
- **3:** ACPI Reclaimable (OS가 ACPI 테이블 읽은 후 사용 가능)
- **4:** ACPI NVS (절전 모드 시 데이터 보존 필요)
- **5:** Bad Memory (불량)

## 3. 전략: 부트로더에서 수집하여 커널로 전달
1. **Loader (Real Mode):** `0xE820`을 반복 호출하여 메모리 맵을 특정 메모리 위치(예: `0x9000` 등 약속된 장소)에 차곡차곡 저장합니다.
2. **Kernel (Long Mode):** 약속된 메모리 위치에서 이 맵을 읽어들여 **물리 메모리 관리자(PMM)**를 초기화합니다.

이 방식을 통해 커널은 자신이 사용할 수 있는 "진짜 RAM"의 목록을 확보하게 됩니다.
