# 06. 디스크 읽기 (Disk Read)

이 문서는 부트로더가 자신의 512바이트 한계를 넘어, 디스크의 나머지 부분에 저장된 커널 코드를 메모리로 읽어오는 방법을 설명합니다.

## 1. 왜 읽어야 하는가?

부트 섹터는 **단 512바이트**입니다. GDT 설정하고 보호 모드 전환 코드만 넣어도 꽉 찹니다. 운영체제의 핵심인 커널(Kernel)은 수 KB에서 수 MB에 달하므로, 부트 섹터 뒤쪽에 이어 붙여서 저장해 두고, 부팅 시 메모리로 읽어와야 합니다.

## 2. BIOS 인터럽트 `INT 0x13`

리얼 모드에서는 BIOS가 제공하는 디스크 서비스(`INT 0x13`)를 사용하여 섹터 단위로 데이터를 읽을 수 있습니다.

**주의**: 우리는 32비트 보호 모드로 넘어가기 **전에** 미리 디스크를 읽어야 합니다. 보호 모드에서는 BIOS 인터럽트를 사용할 수 없기 때문입니다. (보호 모드에서 디스크를 읽으려면 복잡한 ATA 드라이버를 직접 짜야 합니다.)

### 기능 번호 (AH = 0x02)

`INT 0x13`의 `AH=0x02` 기능은 "섹터 읽기"입니다.

### 필요한 파라미터 (레지스터 설정)

| 레지스터 | 설명 | 값 예시 |
| :--- | :--- | :--- |
| **AH** | 기능 번호 | `0x02` (Read Sectors) |
| **AL** | 읽을 섹터 수 | `1` (일단 1개만 읽어봄) |
| **CH** | 실린더 (Cylinder) | `0` (0번 트랙) |
| **DH** | 헤드 (Head) | `0` (0번 헤드) |
| **CL** | 시작 섹터 번호 | **`2`** (1번은 부트 섹터이므로 2번부터 읽음) |
| **DL** | 드라이브 번호 | BIOS가 부팅 시 `DL`에 넣어준 값을 그대로 사용 |
| **ES:BX** | 저장할 메모리 주소 | 데이터를 어디에 복사할지 (버퍼 위치) |

### CHS 주소 지정 방식
위 방식은 **CHS (Cylinder-Head-Sector)** 방식이라고 부릅니다. 오래된 방식이지만 부트로더 단계에서는 가장 호환성이 좋습니다.

-   **Sector 번호는 1부터 시작합니다.** (0이 아님!)
-   따라서 두 번째 섹터(부트 섹터 바로 뒤)는 **2번 섹터**입니다.

## 3. 에러 처리

디스크 읽기는 실패할 수 있습니다 (플로피 디스크 시절에는 흔했습니다).
`INT 0x13` 실행 후 **Carry Flag (CF)**가 1이면 에러가 발생한 것입니다.
이때 `AH` 레지스터에 에러 코드가 담깁니다.

따라서 항상 에러 체크를 해야 합니다.
```nasm
int 0x13
jc disk_error   ; CF가 1이면 에러 점프
```

## 4. 구현 전략

1.  메모리 어디에 커널을 로드할지 정합니다. 보통 `0x1000` (4KB 지점) 같은 안전한 곳을 씁니다.
2.  `ES:BX`를 `0x0000:0x1000`으로 설정합니다.
3.  `BIOS`에게 "2번 섹터부터 N개 읽어서 저기에 놔라"고 명령합니다.
4.  성공하면 보호 모드로 전환합니다.
